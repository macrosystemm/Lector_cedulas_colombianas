<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc√°ner PDF417 ‚Äì Funcional</title>
  <style>
    body { font-family: Arial; padding: 20px; text-align: center; }
    video { width: 90%; max-width: 500px; border: 2px solid #000; }
  </style>
</head>
<body>

<h2>Esc√°ner PDF417 ‚Äì C√©dula Colombiana</h2>
<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const video = document.getElementById("video");

  // Configuraci√≥n para leer solo PDF417 (r√°pido)
  const codeReader = new ZXing.BrowserBarcodeReader(undefined, {
    decodeHints: {
      POSSIBLE_FORMATS: [ ZXing.BarcodeFormat.PDF_417 ]
    }
  });

  let ultimoCodigo = null;
  let ultimoIntento = 0;

  function throttle() {
    const ahora = Date.now();
    if (ahora - ultimoIntento < 200) return false;
    ultimoIntento = ahora;
    return true;
  }

  try {
    // üî• Usamos NAVIGATOR primero sin reproducir, SOLO para obtener permisos
    await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    // üî• Luego ZXing abre la c√°mara por su cuenta (esto S√ç funciona)
    codeReader.decodeFromVideoDevice(undefined, "video", (result, err) => {

      if (!throttle()) return;

      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.warn(err);
      }

      if (result) {
        const codigo = result.getText();
        if (codigo !== ultimoCodigo) {
          ultimoCodigo = codigo;
          alert("C√≥digo le√≠do:\n" + codigo);
        }
      }
    });

  } catch (e) {
    alert("Error al abrir c√°mara: " + e.message);
    console.error(e);
  }

});
</script>

</body>
</html>
